<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro-wheat app</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.27/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.27/"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 30px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group input:disabled {
            background: #e9ecef;
            cursor: not-allowed;
        }

        .coord-group {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .map-section {
            position: relative;
        }

        #viewDiv {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .map-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border-right: 4px solid #ffc107;
        }

        .map-info p {
            margin: 5px 0;
            color: #856404;
        }

        .layer-controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .layer-controls h3 {
            margin-bottom: 10px;
            color: #667eea;
            font-size: 1.1em;
        }

        .layer-btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            color: #667eea;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .layer-btn:hover {
            background: #667eea;
            color: white;
        }

        .layer-btn.active {
            background: #667eea;
            color: white;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .btn {
            flex: 1;
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-clear {
            background: #6c757d;
            color: white;
        }

        .btn-clear:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.4);
        }

        .status-message {
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .status-success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        @media (max-width: 968px) {
            .content {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“ ÙÙˆØ±Ù…Ù‰ ØªÙˆÙ…Ø§Ø±ÙƒØ±Ø¯Ù†Ù‰ Ú†Ø§Ù†Ø¯Ù†Ù‰ Ú¯Ù‡â€ŒÙ†Ù… - Ù¾Ø§Ø±ÛØ²Ú¯Ø§Ù‰ Ù‡Ù‡â€ŒÙˆÙ„ÛØ±</h1>
            <p style="font-size: 1.2em; margin-top: 10px;">Ø´ÙˆÛÙ†Ù‰ Ø¬ÙˆÚ¯Ø±Ø§ÙÙ‰ Ú¯ÛÙ„Ú¯Ù‡â€Œ Ù„Ø³Ù‡â€ŒØ± Ù†Ù‡â€ŒØ®Ø´Ù‡â€Œ Ù‡Ù‡â€ŒÙ„Ø¨Ú˜ÛØ±Ù‡â€Œ Ø¯ÙˆØ§Ù‰ Ø²Ø§Ù†ÙŠØ§Ø±ÙŠÙŠÙ‡â€ŒÙƒØ§Ù† ØªÙˆÙ…Ø§Ø±Ø¨ÙƒÙ‡â€Œ</p>
        </div>

        <div class="content">
            <div class="form-section">
                <h2 style="margin-bottom: 20px; color: #667eea;">ğŸ“ Ø¯Ø§ØªØ§ÙŠÙ‰ Ø¨Ù†Ù‡â€ŒØ±Ù‡â€ŒØªÙ‰ - Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h2>
                
                <div class="form-group">
                    <label>Ù†Ø§ÙˆÙ‰ Ú¯ÙˆÙ†Ø¯ / Ø§Ø³Ù… Ø§Ù„Ù‚Ø±ÙŠØ©:</label>
                    <input type="text" id="villageName" required>
                </div>

                <div class="form-group">
                    <label>Ù†Ø§ÙˆÙ‰ Ø¬ÙˆØªÙŠØ§Ø± / Ø§Ø³Ù… Ø§Ù„Ù…Ø²Ø§Ø±Ø¹:</label>
                    <input type="text" id="farmerName" required>
                </div>

                <div class="form-group">
                    <label>Ú˜Ù…Ø§Ø±Û•ÛŒ Ù…ÙˆØ¨Ø§ÙŠÙ„ / Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„:</label>
                    <input type="tel" id="mobileNumber" required>
                </div>

                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ùˆ Ø§Ù„Ø³Ù†Ø¯ Ø§Ù„Ù…Ù„Ùƒ:</label>
                    <input type="text" id="contractNumber" required>
                </div>

                <div class="form-group">
                    <label>Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù‚Ø¯ Ø§Ùˆ Ø§Ù„Ù…Ù„Ùƒ (Ø¯ÙˆÙ†Ù…):</label>
                    <input type="number" id="propertyArea" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø²Ø±ÙˆØ¹Ø© Ø¯ÙŠÙ… (Ø¯ÙˆÙ†Ù…):</label>
                    <input type="number" id="rainfedArea" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù…Ø²Ø±ÙˆØ¹Ø© Ù…Ø±ÙˆÙŠ (Ø¯ÙˆÙ†Ù…):</label>
                    <input type="number" id="irrigatedArea" step="0.01" required>
                </div>

                <div class="form-group">
                    <label>Ø³Û•Ø±Ú†Ø§ÙˆÛ•ÛŒ Ø¦Ø§Ùˆ / Ù…ØµØ¯Ø± Ø§Ù„Ù…ÙŠØ§Ù‡:</label>
                    <input type="text" id="waterSource" required>
                </div>

                <div class="form-group">
                    <label>Ø¬ÙˆØ±ÛŒ Ø¦Ø§ÙˆØ¯Ø§Ù† / Ù†ÙˆØ¹ Ø§Ù„Ø±ÙŠ:</label>
                    <input type="text" id="waterType" required>
                </div>

                <h3 style="margin: 25px 0 15px 0; color: #667eea;">ğŸ“ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª (ØªÙ„Ù‚Ø§Ø¦ÙŠ)</h3>
                <div class="coord-group">
                    <div class="form-group">
                        <label>X (Ø®Ø· Ø§Ù„Ø·ÙˆÙ„):</label>
                        <input type="text" id="coordX" disabled>
                    </div>
                    <div class="form-group">
                        <label>Y (Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶):</label>
                        <input type="text" id="coordY" disabled>
                    </div>
                    <div class="form-group">
                        <label>Z (Ø§Ù„Ø§Ø±ØªÙØ§Ø¹):</label>
                        <input type="text" id="coordZ" disabled value="0">
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-submit" id="submitBtn">
                        âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                    <button class="btn btn-clear" id="clearBtn">
                        ğŸ—‘ï¸ Ù…Ø³Ø­
                    </button>
                </div>

                <div class="status-message" id="statusMessage"></div>
            </div>

            <div class="map-section">
                <div id="viewDiv"></div>
                <div class="layer-controls">
                    <h3>ğŸ—ºï¸ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</h3>
                    <button class="layer-btn active" id="toggleLayerBtn">
                        Ø¥Ø®ÙØ§Ø¡ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
                    </button>
                    <button class="layer-btn" id="loadManualBtn">
                        ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
                    </button>
                    <button class="layer-btn" id="changeBasemapBtn">
                        ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                    </button>
                    <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                        <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø¨Ù‚Ø©:</strong> <span id="layerStatus">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </p>
                </div>
                <div class="map-info">
                    <p><strong>ğŸ“Œ ÙƒÙŠÙÙŠØ© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</strong></p>
                    <p>1ï¸âƒ£ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</p>
                    <p>2ï¸âƒ£ Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</p>
                    <p>3ï¸âƒ£ Ø£ÙƒÙ…Ù„ Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ£Ø±Ø³Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Google Apps Script Ù‡Ù†Ø§
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx_4FGe6yp8MzhZLMXm6IzQTE5bYTs5UuK9SEJ89Hr9eLccv1goTZH5L6nJHpjuA7Cg/exec';

        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/Graphic",
            "esri/layers/GraphicsLayer",
            "esri/layers/GeoJSONLayer",
            "esri/widgets/Locate",
            "esri/geometry/Polygon",
            "esri/geometry/projection",
            "esri/geometry/SpatialReference",
            "esri/symbols/TextSymbol"
        ], function(Map, MapView, Graphic, GraphicsLayer, GeoJSONLayer, Locate, Polygon, projection, SpatialReference, TextSymbol) {
            
            const graphicsLayer = new GraphicsLayer();
            
            // Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† GeoJSONLayerØŒ Ø³Ù†Ø­Ù…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© ÙˆÙ†Ø¶ÙŠÙÙ‡Ø§ ÙƒÙ€ Graphics
            // Ù„Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ³ØªØ®Ø¯Ù… UTM Zone 38N (WKID: 32638)
            
            // Ø·Ø¨Ù‚Ø© ÙØ§Ø±ØºØ© Ù…Ø¤Ù‚ØªØ© - Ø³Ù†Ù…Ù„Ø£Ù‡Ø§ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            let geojsonLayer = new GraphicsLayer({
                title: "Erbil Districts"
            });
            
            // Ø·Ø¨Ù‚Ø© Ù…Ù†ÙØµÙ„Ø© Ù„Ù„Ù†ØµÙˆØµ (Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚)
            let labelsLayer = new GraphicsLayer({
                title: "District Labels"
            });
            
            const map = new Map({
                basemap: "satellite",
                layers: [geojsonLayer, labelsLayer, graphicsLayer]
            });

            const view = new MapView({
                container: "viewDiv",
                map: map,
                center: [44.0, 36.2],
                zoom: 9,
                constraints: {
                    rotationEnabled: false
                }
            });

            // ØªØ­Ù…ÙŠÙ„ Ø·Ø¨Ù‚Ø© GeoJSON ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            async function loadGeoJSONLayer() {
                try {
                    document.getElementById('layerStatus').textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ...";
                    document.getElementById('layerStatus').style.color = "orange";
                    
                    const response = await fetch('https://sdmnet.github.io/Map_layers/Erbil_dis.geojson');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const geojsonData = await response.json();
                    
                    console.log("ğŸ“Š ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ - Ø¨ÙŠØ§Ù†Ø§Øª GeoJSON:", geojsonData);
                    console.log("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ù…:", geojsonData.features ? geojsonData.features.length : 0);
                    
                    if (!geojsonData.features || geojsonData.features.length === 0) {
                        throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù„Ù… ÙÙŠ Ù…Ù„Ù GeoJSON");
                    }
                    
                    let loadedCount = 0;
                    
                    // Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ù…
                    geojsonData.features.forEach(function(feature, index) {
                        try {
                            let rings = [];
                            
                            if (feature.geometry.type === "Polygon") {
                                rings = feature.geometry.coordinates;
                            } else if (feature.geometry.type === "MultiPolygon") {
                                rings = feature.geometry.coordinates[0];
                            }
                            
                            const polygon = new Polygon({
                                rings: rings,
                                spatialReference: { wkid: 32638 }  // UTM Zone 38N
                            });

                            // Ø±Ù…Ø² Ø®Ø·ÙˆØ· Ù…Ù†Ù‚Ø·Ø© Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¨Ø¦Ø©
                            const lineSymbol = {
                                type: "simple-fill",
                                color: [0, 0, 0, 0],  // Ù„Ø§ ØªØ¹Ø¨Ø¦Ø© (Ø´ÙØ§Ù ØªÙ…Ø§Ù…Ø§Ù‹)
                                outline: {
                                    color: [255, 255, 0],  // Ù„ÙˆÙ† Ø£ØµÙØ± Ù„Ù„Ø­Ø¯ÙˆØ¯
                                    width: 2.5,
                                    style: "dash"  // Ø®Ø·ÙˆØ· Ù…Ù†Ù‚Ø·Ø©
                                }
                            };

                            const polygonGraphic = new Graphic({
                                geometry: polygon,
                                symbol: lineSymbol,
                                attributes: feature.properties || {},
                                popupTemplate: {
                                    title: "{arabic}",
                                    content: function(feature) {
                                        let content = "<div style='padding: 10px;'>";
                                        for (let key in feature.graphic.attributes) {
                                            content += `<p><strong>${key}:</strong> ${feature.graphic.attributes[key]}</p>`;
                                        }
                                        content += "</div>";
                                        return content;
                                    }
                                }
                            });

                            geojsonLayer.add(polygonGraphic);
                            
                            // Ø¥Ø¶Ø§ÙØ© Ù†Øµ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ù…Ø¶Ù„Ø¹ - Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ arabic
                            const centerPoint = polygon.extent.center;
                            const nameField = feature.properties.arabic || 
                                            feature.properties.ARABIC || 
                                            feature.properties.name || 
                                            feature.properties.NAME || 
                                            `Ù…Ù†Ø·Ù‚Ø© ${index + 1}`;
                            
                            const textSymbol = {
                                type: "text",
                                color: [255, 255, 255],
                                haloColor: [0, 0, 0],
                                haloSize: "2px",
                                text: nameField,
                                xoffset: 0,
                                yoffset: 0,
                                font: {
                                    size: 14,
                                    family: "Arial",
                                    weight: "bold"
                                }
                            };

                            const textGraphic = new Graphic({
                                geometry: centerPoint,
                                symbol: textSymbol,
                                attributes: feature.properties || {}
                            });

                            labelsLayer.add(textGraphic);
                            loadedCount++;
                        } catch (featureError) {
                            console.error(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¹Ù„Ù… ${index}:`, featureError);
                        }
                    });

                    console.log(`âœ… ØªØ­Ù…ÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ - ØªÙ… ØªØ­Ù…ÙŠÙ„ ${loadedCount} Ù…Ø¹Ù„Ù…`);
                    document.getElementById('layerStatus').textContent = `âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„ (${loadedCount} Ù…Ø¹Ù„Ù…)`;
                    document.getElementById('layerStatus').style.color = "green";
                    showStatus(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${loadedCount} Ù…Ø¹Ù„Ù… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!`, 'success');
                    
                    // Ø§Ù„ØªØ­Ø±Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                    if (loadedCount > 0) {
                        setTimeout(() => {
                            view.goTo(geojsonLayer.graphics.toArray()).catch(err => {
                                console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ø±Ùƒ:", err);
                            });
                        }, 1000);
                    }
                    
                } catch (error) {
                    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ:", error);
                    document.getElementById('layerStatus').textContent = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ";
                    document.getElementById('layerStatus').style.color = "red";
                    showStatus('âš ï¸ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ØªØ­Ù…ÙŠÙ„ ÙŠØ¯ÙˆÙŠØ§Ù‹"', 'error');
                }
            }

            // ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
            loadGeoJSONLayer();

            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø© - ØªÙ… Ù†Ù‚Ù„Ù‡ Ø¥Ù„Ù‰ Ø¯Ø§Ù„Ø© loadGeoJSONLayer Ø£Ø¹Ù„Ø§Ù‡

            const locate = new Locate({
                view: view,
                rotationEnabled: false,
                goToOverride: function(view, options) {
                    options.target.scale = 1500;
                    return view.goTo(options.target);
                }
            });
            view.ui.add(locate, "top-left");

            let currentPoint = null;
            let isBasemapSatellite = true;

            // Ø²Ø± Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø·Ø¨Ù‚Ø©
            document.getElementById('toggleLayerBtn').addEventListener('click', function() {
                geojsonLayer.visible = !geojsonLayer.visible;
                labelsLayer.visible = !labelsLayer.visible;  // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØµÙˆØµ Ø£ÙŠØ¶Ø§Ù‹
                this.textContent = geojsonLayer.visible ? 'Ø¥Ø®ÙØ§Ø¡ Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚' : 'Ø¥Ø¸Ù‡Ø§Ø± Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚';
                this.classList.toggle('active');
            });

            // Ø²Ø± ØªØ­Ù…ÙŠÙ„ ÙŠØ¯ÙˆÙŠ Ù…Ø­Ø³Ù‘Ù†
            document.getElementById('loadManualBtn').addEventListener('click', async function() {
                try {
                    document.getElementById('layerStatus').textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ...";
                    document.getElementById('layerStatus').style.color = "orange";
                    
                    const response = await fetch('https://sdmnet.github.io/Map_layers/Erbil_dis.geojson');
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const geojsonData = await response.json();
                    
                    console.log("ğŸ“Š Ø¨ÙŠØ§Ù†Ø§Øª GeoJSON:", geojsonData);
                    console.log("ğŸ“Š Ù†ÙˆØ¹:", geojsonData.type);
                    console.log("ğŸ“Š Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ù…:", geojsonData.features ? geojsonData.features.length : 0);
                    
                    if (!geojsonData.features || geojsonData.features.length === 0) {
                        throw new Error("Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù„Ù… ÙÙŠ Ù…Ù„Ù GeoJSON");
                    }
                    
                    // Ù…Ø³Ø­ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
                    geojsonLayer.removeAll();
                    labelsLayer.removeAll();
                    
                    let loadedCount = 0;
                    
                    // Ø±Ø³Ù… Ø§Ù„Ù…Ø¹Ø§Ù„Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹
                    geojsonData.features.forEach(function(feature, index) {
                        try {
                            console.log(`Ù…Ø¹Ø§Ù„Ø¬ ${index}:`, feature.geometry.type, feature.geometry.coordinates);
                            
                            let rings = [];
                            
                            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø£Ù†ÙˆØ§Ø¹ Ù…Ø®ØªÙ„ÙØ© Ù…Ù† Ø§Ù„Ù‡Ù†Ø¯Ø³Ø©
                            if (feature.geometry.type === "Polygon") {
                                rings = feature.geometry.coordinates;
                            } else if (feature.geometry.type === "MultiPolygon") {
                                // ÙÙŠ Ø­Ø§Ù„Ø© MultiPolygonØŒ Ù†Ø£Ø®Ø° Ø£ÙˆÙ„ polygon
                                rings = feature.geometry.coordinates[0];
                            }
                            
                            const polygon = new Polygon({
                                rings: rings,
                                spatialReference: { wkid: 32638 }  // UTM Zone 38N
                            });

                            // Ø±Ù…Ø² Ø®Ø·ÙˆØ· Ù…Ù†Ù‚Ø·Ø© Ø¨Ø¯ÙˆÙ† ØªØ¹Ø¨Ø¦Ø©
                            const lineSymbol = {
                                type: "simple-fill",
                                color: [0, 0, 0, 0],  // Ù„Ø§ ØªØ¹Ø¨Ø¦Ø© (Ø´ÙØ§Ù ØªÙ…Ø§Ù…Ø§Ù‹)
                                outline: {
                                    color: [255, 255, 0],  // Ù„ÙˆÙ† Ø£ØµÙØ± Ù„Ù„Ø­Ø¯ÙˆØ¯
                                    width: 2.5,
                                    style: "dash"  // Ø®Ø·ÙˆØ· Ù…Ù†Ù‚Ø·Ø©
                                }
                            };

                            const polygonGraphic = new Graphic({
                                geometry: polygon,
                                symbol: lineSymbol,
                                attributes: feature.properties || {},
                                popupTemplate: {
                                    title: "{arabic}",
                                    content: function(feature) {
                                        let content = "<div style='padding: 10px;'>";
                                        for (let key in feature.graphic.attributes) {
                                            content += `<p><strong>${key}:</strong> ${feature.graphic.attributes[key]}</p>`;
                                        }
                                        content += "</div>";
                                        return content;
                                    }
                                }
                            });

                            geojsonLayer.add(polygonGraphic);
                            
                            // Ø¥Ø¶Ø§ÙØ© Ù†Øµ ÙÙŠ ÙˆØ³Ø· Ø§Ù„Ù…Ø¶Ù„Ø¹ - Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø­Ù‚Ù„ arabic
                            const centerPoint = polygon.extent.center;
                            const nameField = feature.properties.arabic || 
                                            feature.properties.ARABIC || 
                                            feature.properties.name || 
                                            feature.properties.NAME || 
                                            `Ù…Ù†Ø·Ù‚Ø© ${index + 1}`;
                            
                            const textSymbol = {
                                type: "text",
                                color: [255, 255, 255],
                                haloColor: [0, 0, 0],
                                haloSize: "2px",
                                text: nameField,
                                xoffset: 0,
                                yoffset: 0,
                                font: {
                                    size: 14,
                                    family: "Arial",
                                    weight: "bold"
                                }
                            };

                            const textGraphic = new Graphic({
                                geometry: centerPoint,
                                symbol: textSymbol,
                                attributes: feature.properties || {}
                            });

                            labelsLayer.add(textGraphic);
                            loadedCount++;
                        } catch (featureError) {
                            console.error(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ø¹Ù„Ù… ${index}:`, featureError);
                        }
                    });

                    console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${loadedCount} Ù…Ù† ${geojsonData.features.length} Ù…Ø¹Ù„Ù…`);
                    document.getElementById('layerStatus').textContent = `âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${loadedCount} Ù…Ø¹Ù„Ù…`;
                    document.getElementById('layerStatus').style.color = "green";
                    showStatus(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${loadedCount} Ù…Ø¹Ù„Ù… Ø¨Ù†Ø¬Ø§Ø­!`, 'success');
                    
                    // Ø§Ù„ØªØ­Ø±Ùƒ Ø¥Ù„Ù‰ Ø§Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ù…Ø­Ù…Ù„Ø©
                    if (loadedCount > 0) {
                        view.goTo(geojsonLayer.graphics.toArray());
                    }
                    
                } catch (error) {
                    console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ:", error);
                    document.getElementById('layerStatus').textContent = "âŒ ÙØ´Ù„: " + error.message;
                    document.getElementById('layerStatus').style.color = "red";
                    showStatus('âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ' + error.message, 'error');
                }
            });

            // Ø²Ø± ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
            document.getElementById('changeBasemapBtn').addEventListener('click', function() {
                if (isBasemapSatellite) {
                    map.basemap = "topo-vector";
                    this.textContent = "Ø¹Ø±Ø¶ ØµÙˆØ±Ø© Ø§Ù„Ù‚Ù…Ø± Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ";
                } else {
                    map.basemap = "satellite";
                    this.textContent = "ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©";
                }
                isBasemapSatellite = !isBasemapSatellite;
            });

            view.on("click", function(event) {
                // Ù„Ø§ Ù†Ù…Ø³Ø­ Ø·Ø¨Ù‚Ø© GeoJSONØŒ ÙÙ‚Ø· Ù†Ù…Ø³Ø­ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                graphicsLayer.removeAll();
                
                const point = {
                    type: "point",
                    longitude: event.mapPoint.longitude,
                    latitude: event.mapPoint.latitude
                };

                const markerSymbol = {
                    type: "simple-marker",
                    color: [226, 119, 40],
                    outline: {
                        color: [255, 255, 255],
                        width: 3
                    },
                    size: 15
                };

                const pointGraphic = new Graphic({
                    geometry: point,
                    symbol: markerSymbol
                });

                graphicsLayer.add(pointGraphic);

                document.getElementById('coordX').value = event.mapPoint.longitude.toFixed(6);
                document.getElementById('coordY').value = event.mapPoint.latitude.toFixed(6);
                
                currentPoint = event.mapPoint;
            });

            document.getElementById('submitBtn').addEventListener('click', async function() {
                if (!validateForm()) {
                    showStatus('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
                    return;
                }

                const formData = {
                    villageName: document.getElementById('villageName').value,
                    farmerName: document.getElementById('farmerName').value,
                    mobileNumber: document.getElementById('mobileNumber').value,
                    contractNumber: document.getElementById('contractNumber').value,
                    propertyArea: document.getElementById('propertyArea').value,
                    rainfedArea: document.getElementById('rainfedArea').value,
                    irrigatedArea: document.getElementById('irrigatedArea').value,
                    waterSource: document.getElementById('waterSource').value,
                    waterType: document.getElementById('waterType').value,
                    coordX: document.getElementById('coordX').value,
                    coordY: document.getElementById('coordY').value,
                    coordZ: document.getElementById('coordZ').value,
                    timestamp: new Date().toISOString()
                };

                try {
                    document.getElementById('submitBtn').disabled = true;
                    document.getElementById('submitBtn').textContent = 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(formData)
                    });

                    showStatus('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                    clearForm();
                    graphicsLayer.removeAll(); // Ù…Ø³Ø­ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·

                } catch (error) {
                    console.error('Error:', error);
                    showStatus('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰', 'error');
                } finally {
                    document.getElementById('submitBtn').disabled = false;
                    document.getElementById('submitBtn').textContent = 'âœ‰ï¸ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
                }
            });

            document.getElementById('clearBtn').addEventListener('click', function() {
                clearForm();
                graphicsLayer.removeAll(); // Ù…Ø³Ø­ Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø·
            });

            function validateForm() {
                const requiredFields = [
                    'villageName', 'farmerName', 'mobileNumber', 'contractNumber',
                    'propertyArea', 'rainfedArea', 'irrigatedArea', 'waterSource', 'waterType',
                    'coordX', 'coordY'
                ];

                for (let field of requiredFields) {
                    if (!document.getElementById(field).value) {
                        return false;
                    }
                }
                return true;
            }

            function clearForm() {
                document.getElementById('villageName').value = '';
                document.getElementById('farmerName').value = '';
                document.getElementById('mobileNumber').value = '';
                document.getElementById('contractNumber').value = '';
                document.getElementById('propertyArea').value = '';
                document.getElementById('rainfedArea').value = '';
                document.getElementById('irrigatedArea').value = '';
                document.getElementById('waterSource').value = '';
                document.getElementById('waterType').value = '';
                document.getElementById('coordX').value = '';
                document.getElementById('coordY').value = '';
                document.getElementById('coordZ').value = '0';
            }

            function showStatus(message, type) {
                const statusDiv = document.getElementById('statusMessage');
                statusDiv.textContent = message;
                statusDiv.className = 'status-message status-' + type;
                statusDiv.style.display = 'block';

                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 5000);
            }
        });
    </script>
</body>
</html>
